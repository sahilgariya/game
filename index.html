<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Emoji Survival - Advanced</title>
<style>
html,body{height:100%;margin:0;background:#0b1020;font-family:sans-serif;overflow:hidden}
#game-wrap{position:relative;width:100%;height:100%;}
canvas{display:block;margin:0 auto;background:#081226;border-radius:12px}
.joystick{position:absolute;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,0.08);touch-action:none;}
.joystickInner{position:absolute;top:50%;left:50%;width:60px;height:60px;margin:-30px 0 0 -30px;border-radius:50%;background:rgba(255,255,255,0.3);}
.hud{position:absolute;right:20px;top:20px;color:#fff;font-weight:700;text-align:right}
.centerPanel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(15,20,30,.9);padding:18px;border-radius:12px;color:#fff;display:none;min-width:240px;text-align:center}
.centerPanel.show{display:block}
button{background:#ffd166;border:none;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer;margin:3px}
#inventory{position:absolute;bottom:140px;left:50%;transform:translateX(-50%);display:flex;gap:10px;}
.inventory-btn{width:60px;height:60px;border-radius:10px;background:rgba(255,255,255,0.1);color:#fff;font-size:24px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:2px solid #fff;}
#activeBuffs{position:absolute;top:120px;left:20px;color:#0ff;font-weight:700;}
</style>
</head>
<body>
<div id="game-wrap">
  <canvas id="game" width="900" height="600"></canvas>
  <div class="joystick" id="moveJoystick" style="bottom:20px;left:20px;"><div class="joystickInner"></div></div>
  <div class="joystick" id="fireJoystick" style="bottom:20px;right:20px;"><div class="joystickInner"></div></div>
</div>

<div class="hud">
Score: <span id="score">0</span><br>
Wave: <span id="wave">0</span><br>
Health: <span id="health">100</span><br>
Coins: <span id="coin">0</span>
</div>

<div id="inventory"></div>
<div id="activeBuffs"></div>

<div class="centerPanel" id="menu">
<h2>2D Survival Emoji Game</h2>
<p>Use WASD / Arrow keys to move, Mouse to shoot. Touch joystick also works.</p>
<p>Collect special items into 4 inventory slots and use them anytime.</p>
<button id="startBtn">Start Game</button>
</div>

<div class="centerPanel" id="gameOver">
<h2>Game Over</h2>
<p id="finalScore">You scored 0</p>
<p id="finalCoin">Coins collected: 0</p>
<button id="restartBtn">Play Again</button>
</div>

<script>
const W = canvas.width, H = canvas.height;
const scoreEl = document.getElementById('score');
const waveEl = document.getElementById('wave');
const healthEl = document.getElementById('health');
const coinEl = document.getElementById('coin');
const menu = document.getElementById('menu');
const gameOverPanel = document.getElementById('gameOver');
const finalScore = document.getElementById('finalScore');
const finalCoin = document.getElementById('finalCoin');
const inventoryDiv = document.getElementById('inventory');
const activeBuffsDiv = document.getElementById('activeBuffs');

const moveJoystick = document.getElementById('moveJoystick');
const fireJoystick = document.getElementById('fireJoystick');
const moveInner = moveJoystick.querySelector('.joystickInner');
const fireInner = fireJoystick.querySelector('.joystickInner');

let running=false,lastTime=0;
let player, bullets=[], enemies=[], items=[];
let score=0,wave=0,spawnTimer=0,spawnInterval=2000,enemySpeed=0.7,coins=0;
let input = {moveX:0, moveY:0, fireX:0, fireY:0, firing:false};
let fireJoystickTouchActive=false;
let inventory = [null,null,null,null]; // 4 special slots
let buffs = {}; // Active buffs with timers

// Utilities
function rand(min,max){return Math.random()*(max-min)+min;}
function dist(a,b){return Math.hypot(a.x-b.x, a.y-b.y);}
function createPlayer(){
let player = {
  x: canvas.width * 0.1,
  y: canvas.height / 2,
  width: 50,
  height: 50
};    
    return { 
        x: W/2, y: H/2, r: 20, health: 100, fireCooldown: 0, speed: 2.4, 
        speedBoostTimer: 0, shieldTimer: 0, buffFireRate: 0, damageCooldown: 0
    };
}

// Enemy spawn
function spawnEnemy(){
    const side = Math.floor(rand(0,4));
    let x,y; const pad=30;
    if(side===0) x=-pad,y=rand(0,H);
    else if(side===1) x=W+pad,y=rand(0,H);
    else if(side===2) x=rand(0,W),y=-pad;
    else x=rand(0,W),y=H+pad;
    enemies.push({x,y,r:20,hp:20});
}

// Item spawn
function spawnItem(){
    const types = ['medicine','speed','shield','bullet','coin','bomb','freeze','doubleCoin','laser','magnet','armor','extraLife'];
    const type = types[Math.floor(rand(0,types.length))];
    const x = rand(50,W-50);
    const y = rand(50,H-50);
    items.push({x,y,r:15,type});
}

// Inventory HUD
function updateInventory(){
    inventoryDiv.innerHTML = '';
    inventory.forEach((item,index)=>{
        const btn = document.createElement('div');
        btn.className = 'inventory-btn';
        btn.textContent = item ? item.icon : '';
        btn.onclick = ()=>{ if(item) useInventoryItem(index); };
        inventoryDiv.appendChild(btn);
    });
}

// Active Buffs HUD
function updateBuffsHUD(){
    activeBuffsDiv.innerHTML='';
    for(const key in buffs){
        activeBuffsDiv.innerHTML += `${key}: ${Math.ceil(buffs[key])}s<br>`;
    }
}

// Use inventory item
function useInventoryItem(index){
    const item = inventory[index];
    if(!item) return;
    switch(item.type){
        case 'bomb': enemies=[]; break;
        case 'freeze': buffs.freeze=5; break;
        case 'doubleCoin': buffs.doubleCoin=10; break;
        case 'laser': buffs.laser=5; break;
        case 'magnet': buffs.magnet=8; break;
        case 'armor': buffs.armor=6; break;
        case 'extraLife': player.health=100; break;
    }
    inventory[index] = null;
    updateInventory();
}

// Update per frame
function update(dt){
    // Reduce buff timers
    for(const key in buffs){ buffs[key]-=dt; if(buffs[key]<=0) delete buffs[key]; }
    updateBuffsHUD();

    if(player.speedBoostTimer>0) player.speedBoostTimer-=dt;
    if(player.shieldTimer>0) player.shieldTimer-=dt;
    if(player.buffFireRate>0) player.buffFireRate-=dt;
    if(player.damageCooldown>0) player.damageCooldown -= 1;

    // Move player
    let dx=input.moveX, dy=input.moveY;
    if(dx||dy){
        const mag=Math.hypot(dx,dy); dx/=mag; dy/=mag;
        let speed = player.speed;
        if(player.speedBoostTimer>0) speed*=1.5;
        player.x += dx*speed*dt*60/16;
        player.y += dy*speed*dt*60/16;
    }
    player.x=Math.max(player.r,Math.min(W-player.r,player.x));
    player.y=Math.max(player.r,Math.min(H-player.r,player.y));

    // Fire bullets
    if(input.firing && player.fireCooldown<=0){
        const speed=7.5;
        const angle = Math.atan2(input.fireY, input.fireX);
        bullets.push({x:player.x,y:player.y,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,life:160});
        player.fireCooldown = player.buffFireRate>0?4:8;
    }
    if(player.fireCooldown>0) player.fireCooldown--;

    // Update bullets
    bullets.forEach((b,i)=>{
        b.x+=b.vx*dt*60/16; b.y+=b.vy*dt*60/16; b.life--;
        if(b.life<=0) bullets.splice(i,1);
    });

    // Spawn enemies & items
    spawnTimer+=dt*1000;
    if(spawnTimer>spawnInterval){
        spawnTimer=0;
        spawnEnemy();
        if(Math.random()<0.3) spawnItem();
        wave++;
        waveEl.textContent=wave;
    }

    // Update enemies
    enemies.forEach((e,i)=>{
        const angle = Math.atan2(player.y-e.y, player.x-e.x);
        let speed = (0.7+enemySpeed*0.2);
        if(buffs.freeze) speed=0;
        e.x += Math.cos(angle)*speed*dt*60/16;
        e.y += Math.sin(angle)*speed*dt*60/16;

        if(dist(e,player)<40){
            if(player.damageCooldown <= 0 && player.shieldTimer <= 0 && !buffs.armor){
                player.health = Math.max(0, player.health - 33);
                player.damageCooldown = 60;
            }
            e.hp = 0;
        }

        bullets.forEach((b,j)=>{
            if(dist(b,e)<20){
                e.hp-=12; 
                bullets.splice(j,1);
                if(e.hp<=0){ 
                    score+=20; 
                    coins += buffs.doubleCoin? 2:1;
                    enemies.splice(i,1); 
                }
            }
        });
    });

    // Check item pickup
    items.forEach((item,i)=>{
        if(dist(item,player)<25){
            // If special item and inventory full, skip
            const special = ['bomb','freeze','doubleCoin','laser','magnet','armor','extraLife'];
            if(special.includes(item.type)){
                const emptySlot = inventory.findIndex(v=>v===null);
                if(emptySlot!==-1){
                    inventory[emptySlot] = {type:item.type, icon:itemIcon(item.type)};
                    updateInventory();
                    items.splice(i,1);
                    return;
                }
            }
            // Normal effect
            switch(item.type){
                case 'medicine': player.health=Math.min(100, player.health+25); break;
                case 'speed': player.speedBoostTimer=5; break;
                case 'shield': player.shieldTimer=3; break;
                case 'bullet': player.buffFireRate=5; break;
                case 'coin': coins += buffs.doubleCoin? 2:1; break;
            }
            items.splice(i,1);
        }
    });

    scoreEl.textContent=score;
    healthEl.textContent=Math.max(0,Math.round(player.health));
    coinEl.textContent=coins;

    if(player.health<=0) endGame();
}

// Draw everything
function draw(){
    ctx.clearRect(0,0,W,H);

    // Items
    items.forEach(item=>{
        ctx.font='24px serif';
        ctx.fillText(itemIcon(item.type),item.x,item.y);
    });

    // Player
    ctx.font='40px serif';
    ctx.fillStyle=player.shieldTimer>0?'#00ffff':'#ffff00';
    ctx.fillText('üòÄ',player.x,player.y);

    ctx.fillStyle='#555';
    ctx.fillRect(player.x-25,player.y-40,50,6);
    ctx.fillStyle='#0f0';
    ctx.fillRect(player.x-25,player.y-40,50*player.health/100,6);

    ctx.font='36px serif';
    ctx.fillStyle='#ff4444';
    enemies.forEach(e=>{ctx.fillText('ü§°', e.x,e.y);});

    ctx.fillStyle='#bfe3ff';
    bullets.forEach(b=>{ctx.beginPath();ctx.arc(b.x,b.y,4,0,Math.PI*2);ctx.fill();});
}

function itemIcon(type){
    const icons = {medicine:'üíä',speed:'‚ö°',shield:'üõ°Ô∏è',bullet:'üîπ',coin:'üü°',bomb:'üí£',freeze:'‚ùÑÔ∏è',doubleCoin:'üí∞',laser:'üî•',magnet:'üß≤',armor:'ü¶æ',extraLife:'‚ù§Ô∏è'};
    return icons[type]||'?';
}

function loop(ts){if(!running)return;const dt=Math.min(0.035,(ts-lastTime)/1000||0.016);lastTime=ts;update(dt);draw();requestAnimationFrame(loop);}

function startGame(){
    player=createPlayer(); bullets=[]; enemies=[]; items=[]; coins=0;
    score=0; wave=0; spawnTimer=0; enemySpeed=0.7;
    inventory=[null,null,null,null];
    buffs={};
    scoreEl.textContent=0; waveEl.textContent=0; healthEl.textContent=player.health; coinEl.textContent=coins;
    menu.classList.remove('show'); gameOverPanel.classList.remove('show');
    running=true; lastTime=performance.now();
    for(let i=0;i<3;i++) spawnEnemy();
    updateInventory();
    requestAnimationFrame(loop);
}

function endGame(){
    running=false; 
    finalScore.textContent='You scored '+score; 
    finalCoin.textContent='Coins collected: '+coins;
    gameOverPanel.classList.add('show');
}

document.getElementById('startBtn').addEventListener('click',startGame);
document.getElementById('restartBtn').addEventListener('click',()=>{gameOverPanel.classList.remove('show'); startGame();});
menu.classList.add('show');

// Joystick handler
function setupJoystick(joystickEl,innerEl, onMove){
    let touchId=null,pos={x:0,y:0};
    joystickEl.addEventListener('pointerdown', e=>{
        touchId=e.pointerId;
        const rect=joystickEl.getBoundingClientRect();
        pos.x=e.clientX-rect.left-rect.width/2;
        pos.y=e.clientY-rect.top-rect.height/2;
        move(); e.preventDefault();
    });
    joystickEl.addEventListener('pointermove', e=>{
        if(e.pointerId!==touchId) return;
        const rect=joystickEl.getBoundingClientRect();
        pos.x=e.clientX-rect.left-rect.width/2;
        pos.y=e.clientY-rect.top-rect.height/2;
        move();
    });
    joystickEl.addEventListener('pointerup', e=>{
        if(e.pointerId!==touchId) return;
        touchId=null; innerEl.style.transform='translate(0px,0px)'; onMove(0,0);
    });
    function move(){
        const max=40;
        const dx=Math.max(-max,Math.min(max,pos.x));
        const dy=Math.max(-max,Math.min(max,pos.y));
        innerEl.style.transform=`translate(${dx}px,${dy}px)`;
        onMove(dx/max,dy/max);
    }
}

setupJoystick(moveJoystick, moveInner, (x,y)=>{input.moveX=x; input.moveY=y;});
setupJoystick(fireJoystick, fireInner, (x,y)=>{input.fireX=x; input.fireY=y; input.firing=(x!==0||y!==0);});

// Keyboard support for PC
document.addEventListener('keydown', e=>{
    if(e.key==='ArrowUp'||e.key==='w') input.moveY=-1;
    if(e.key==='ArrowDown'||e.key==='s') input.moveY=1;
    if(e.key==='ArrowLeft'||e.key==='a') input.moveX=-1;
    if(e.key==='ArrowRight'||e.key==='d') input.moveX=1;
    if(e.key===' ') input.firing=true;
});
document.addEventListener('keyup', e=>{
    if(e.key==='ArrowUp'||e.key==='w'||e.key==='ArrowDown'||e.key==='s') input.moveY=0;
    if(e.key==='ArrowLeft'||e.key==='a'||e.key==='ArrowRight'||e.key==='d') input.moveX=0;
    if(e.key===' ') input.firing=false;
});
</script>
</body>
</html>







